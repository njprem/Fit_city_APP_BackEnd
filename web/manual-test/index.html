<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitCity API Manual Tester</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      font-family: Arial, sans-serif;
      background: #f4f6fb;
      color: #1f2933;
    }
    body {
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f5eff;
      color: #fff;
      padding: 32px;
      text-align: center;
    }
    main {
      padding: 32px;
      display: grid;
      gap: 24px;
    }
    .tab-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .tab-button {
      border: none;
      background: #e2e8f0;
      color: #143d8f;
      padding: 10px 20px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s, color 0.2s;
    }
    .tab-button.active {
      background: #1f5eff;
      color: #fff;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    .panel-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    section {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(31, 93, 255, 0.07);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    section h2 {
      margin: 0;
      font-size: 1.3rem;
      color: #143d8f;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d7e7;
      border-radius: 6px;
      font-size: 1rem;
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    button {
      align-self: flex-start;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      background: #1f5eff;
      color: #fff;
      transition: background 0.2s;
    }
    button:hover {
      background: #1746bd;
    }
    button.danger {
      background: #d14343;
    }
    button.danger:hover {
      background: #aa2c2c;
    }
    .muted {
      font-size: 0.85rem;
      color: #5c6b80;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row input, .row select {
      flex: 1;
    }
    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.85rem;
      max-height: 240px;
    }
    .profile-card {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      border: 1px solid #d0d7e7;
      border-radius: 8px;
      padding: 16px;
      background: #f9fafc;
    }
    .profile-card img {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      background: #e2e8f0;
    }
    .profile-details {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }
    .profile-details .value {
      font-weight: 600;
      margin-left: 4px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .profile-image-url {
      font-size: 0.85rem;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .profile-image-url a {
      color: #1f5eff;
      text-decoration: none;
    }
    .profile-image-url a:hover {
      text-decoration: underline;
    }
    .user-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }
    .user-list li {
      border: 1px solid #d0d7e7;
      border-radius: 8px;
      padding: 12px;
      background: #f9fafc;
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }
    .user-list li .user-meta {
      font-size: 0.75rem;
      color: #5c6b80;
    }
  </style>
</head>
<body>
  <header>
    <h1>FitCity API Manual Tester</h1>
    <p class="muted">Toggle between Auth and Destination Management to manually exercise backend endpoints.</p>
  </header>

  <main>
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="authTab">Auth</button>
      <button class="tab-button" data-tab="managementTab">Destination Management</button>
    </div>

    <div id="authTab" class="tab-panel active">
      <div class="panel-grid">
        <section>
          <h2>Configuration</h2>
          <label for="baseUrl">API base URL</label>
          <input id="baseUrl" type="text" value="http://localhost:8080" />
          <label for="googleClientId">Google OAuth client ID</label>
          <input id="googleClientId" type="text" value="128350041183-jn7nlbtjris83v4jtedt6mekrbjvij95.apps.googleusercontent.com" />
          <label for="tokenDisplay">Active JWT</label>
          <textarea id="tokenDisplay" readonly placeholder="Tokens appear here after successful auth."></textarea>
          <div class="muted">Tokens are also stored in localStorage as <code>fitcity_token</code>.</div>
        </section>

        <section>
          <h2>Email Registration</h2>
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" placeholder="user@example.com" />
          <label for="regPassword">Password</label>
          <input id="regPassword" type="password" placeholder="password" />
          <button id="regSubmit">Register</button>
          <pre id="regResult"></pre>
        </section>

        <section>
          <h2>Email Login</h2>
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="user@example.com" />
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="password" />
          <button id="loginSubmit">Login</button>
          <pre id="loginResult"></pre>
        </section>

        <section>
          <h2>Google Login</h2>
          <p class="muted">Paste a Google ID token (from OAuth playground or your own client) to hit <code>/api/v1/auth/google</code>.</p>
          <textarea id="googleIdToken" placeholder="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>
          <div id="googleButtonContainer"></div>
          <button id="googleSubmit">Login with Google token</button>
          <pre id="googleResult"></pre>
        </section>

        <section>
          <h2>Complete Profile</h2>
          <label for="profileName">Full name</label>
          <input id="profileName" type="text" placeholder="Jane Doe" />
          <label for="profileUsername">Username</label>
          <input id="profileUsername" type="text" placeholder="janedoe" />
          <label for="profileAvatar">Avatar (optional image)</label>
          <input id="profileAvatar" type="file" accept="image/*" />
          <button id="profileSubmit">Submit profile</button>
          <pre id="profileResult"></pre>
        </section>

        <section>
          <h2>Change Password</h2>
          <p class="muted">Requires an authenticated session. Leave current password blank if your account never had one.</p>
          <label for="changeCurrentPassword">Current password</label>
          <input id="changeCurrentPassword" type="password" placeholder="Current password" />
          <label for="changeNewPassword">New password</label>
          <input id="changeNewPassword" type="password" placeholder="New password" />
          <button id="changePasswordSubmit">Update password</button>
          <pre id="changePasswordResult"></pre>
        </section>

        <section>
          <h2>Password Reset</h2>
          <div>
            <h3>Request code</h3>
            <label for="resetEmailRequest">Account email</label>
            <input id="resetEmailRequest" type="email" placeholder="user@example.com" />
            <button id="resetRequestSubmit">Send reset code</button>
            <pre id="resetRequestResult"></pre>
          </div>
          <div>
            <h3>Confirm reset</h3>
            <label for="resetEmailConfirm">Account email</label>
            <input id="resetEmailConfirm" type="email" placeholder="user@example.com" />
            <label for="resetOTP">Reset code (OTP)</label>
            <input id="resetOTP" type="text" placeholder="123456" />
            <label for="resetNewPassword">New password</label>
            <input id="resetNewPassword" type="password" placeholder="New password" />
            <button id="resetConfirmSubmit">Confirm password reset</button>
            <pre id="resetConfirmResult"></pre>
          </div>
        </section>

        <section>
          <h2>User Directory</h2>
          <p class="muted">Calls <code>/api/v1/auth/users</code> with the stored token. Limit is capped at 200 by the API.</p>
          <label for="userListLimit">Limit</label>
          <input id="userListLimit" type="number" min="1" max="200" value="20" />
          <label for="userListOffset">Offset</label>
          <input id="userListOffset" type="number" min="0" value="0" />
          <button id="userListSubmit">Fetch users</button>
          <pre id="userListResult"></pre>
          <div id="userListMeta" class="muted">Run the request to see pagination metadata.</div>
          <div id="userListEmpty" class="muted">No users loaded yet.</div>
          <ul id="userListItems" class="user-list hidden"></ul>
        </section>

        <section>
          <h2>Who Am I</h2>
          <p class="muted">Calls <code>/api/v1/auth/me</code> using the stored token.</p>
          <button id="meSubmit">Fetch profile</button>
          <pre id="meResult"></pre>
          <div id="profileCardEmpty" class="muted">Fetch profile to display user details and avatar.</div>
          <div id="profileCard" class="profile-card hidden">
            <img id="profileAvatarPreview" alt="Profile avatar placeholder" />
            <div class="profile-details">
              <div><strong>ID:</strong><span id="profileFieldId" class="value">&mdash;</span></div>
              <div><strong>Email:</strong><span id="profileFieldEmail" class="value">&mdash;</span></div>
              <div><strong>Username:</strong><span id="profileFieldUsername" class="value">&mdash;</span></div>
              <div><strong>Full name:</strong><span id="profileFieldFullName" class="value">&mdash;</span></div>
              <div><strong>Primary role:</strong><span id="profileFieldPrimaryRole" class="value">&mdash;</span></div>
              <div><strong>All roles:</strong><span id="profileFieldRoles" class="value">&mdash;</span></div>
              <div><strong>Profile completed:</strong><span id="profileFieldCompleted" class="value">&mdash;</span></div>
              <div><strong>Created at:</strong><span id="profileFieldCreatedAt" class="value">&mdash;</span></div>
              <div><strong>Updated at:</strong><span id="profileFieldUpdatedAt" class="value">&mdash;</span></div>
              <div class="profile-image-url">
                <strong>Avatar URL:</strong>
                <a id="profileAvatarLink" class="hidden" target="_blank" rel="noopener noreferrer"></a>
                <span id="profileAvatarPlaceholder" class="value">No avatar uploaded</span>
              </div>
            </div>
          </div>
          <button id="logoutSubmit">Logout</button>
          <pre id="logoutResult"></pre>
        </section>
      </div>
    </div>

    <div id="managementTab" class="tab-panel">
      <div class="panel-grid">
        <section>
          <h2>Management Configuration</h2>
          <p class="muted">Author actions (create, submit, hero upload) use the author token. Approvals and rejections use the reviewer token.</p>
          <label for="mgmtAuthorToken">Author token (defaults to auth tab token)</label>
          <textarea id="mgmtAuthorToken" placeholder="Author JWT"></textarea>
          <label for="mgmtReviewerToken">Reviewer token</label>
          <textarea id="mgmtReviewerToken" placeholder="Reviewer JWT"></textarea>
          <div class="muted">Reviewer token is stored in localStorage as <code>fitcity_reviewer_token</code>.</div>
        </section>

        <section>
          <h2>Create Draft</h2>
          <label for="mgmtCreateAction">Action</label>
          <select id="mgmtCreateAction">
            <option value="create">create</option>
            <option value="update">update</option>
            <option value="delete">delete</option>
          </select>
          <label for="mgmtCreateDestinationId">Destination ID (required for update/delete)</label>
          <input id="mgmtCreateDestinationId" type="text" placeholder="uuid" />
          <label for="mgmtCreateFields">Fields JSON</label>
          <textarea id="mgmtCreateFields">{ "name": "Sample Destination", "city": "New York", "country": "USA", "category": "Nature", "description": "Iconic destination", "status": "draft" }</textarea>
          <button id="mgmtCreateSubmit">Send draft</button>
          <pre id="mgmtCreateResult"></pre>
        </section>

        <section>
          <h2>Submit Draft</h2>
          <label for="mgmtSubmitChangeId">Change request ID</label>
          <input id="mgmtSubmitChangeId" type="text" placeholder="uuid" />
          <button id="mgmtSubmitChange">Submit for review</button>
          <pre id="mgmtSubmitResult"></pre>
        </section>

        <section>
          <h2>Approve Change</h2>
          <p class="muted">Uses the reviewer token.</p>
          <label for="mgmtApproveChangeId">Change request ID</label>
          <input id="mgmtApproveChangeId" type="text" placeholder="uuid" />
          <button id="mgmtApproveChange">Approve</button>
          <pre id="mgmtApproveResult"></pre>
        </section>

        <section>
          <h2>Reject Change</h2>
          <label for="mgmtRejectChangeId">Change request ID</label>
          <input id="mgmtRejectChangeId" type="text" placeholder="uuid" />
          <label for="mgmtRejectMessage">Reviewer message</label>
          <input id="mgmtRejectMessage" type="text" placeholder="Reason for rejection" />
          <button id="mgmtRejectChange">Reject</button>
          <pre id="mgmtRejectResult"></pre>
        </section>

        <section>
          <h2>Upload Hero Image</h2>
          <label for="mgmtHeroChangeId">Change request ID</label>
          <input id="mgmtHeroChangeId" type="text" placeholder="uuid" />
          <label for="mgmtHeroFile">Hero image</label>
          <input id="mgmtHeroFile" type="file" accept="image/*" />
          <button id="mgmtHeroUpload">Upload hero image</button>
          <pre id="mgmtHeroResult"></pre>
        </section>

        <section>
          <h2>List Change Requests</h2>
          <label for="mgmtListStatus">Statuses (comma separated)</label>
          <input id="mgmtListStatus" type="text" placeholder="draft,pending_review" />
          <label for="mgmtListDestinationId">Destination ID filter</label>
          <input id="mgmtListDestinationId" type="text" placeholder="uuid" />
          <div class="row">
            <div>
              <label for="mgmtListLimit">Limit</label>
              <input id="mgmtListLimit" type="number" min="1" value="20" />
            </div>
            <div>
              <label for="mgmtListOffset">Offset</label>
              <input id="mgmtListOffset" type="number" min="0" value="0" />
            </div>
          </div>
          <button id="mgmtListChanges">Fetch change requests</button>
          <pre id="mgmtListResult"></pre>
        </section>

        <section>
          <h2>Get Change Request</h2>
          <label for="mgmtGetChangeId">Change request ID</label>
          <input id="mgmtGetChangeId" type="text" placeholder="uuid" />
          <button id="mgmtGetChange">Fetch change</button>
          <pre id="mgmtGetResult"></pre>
        </section>

        <section>
          <h2>Published Destinations</h2>
          <p class="muted">Calls <code>/api/v1/destinations</code>. All users can access this endpoint.</p>
          <button id="mgmtListPublished">List published destinations</button>
          <pre id="mgmtListPublishedResult"></pre>
        </section>
      </div>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = {
      token: localStorage.getItem('fitcity_token') || '',
    };
    const managementState = {
      reviewerToken: localStorage.getItem('fitcity_reviewer_token') || '',
    };
    const googleState = {
      initTimer: null,
      lastClientId: null,
    };
    const PLACEHOLDER_IMAGE = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

    function activateTab(tabId) {
      document.querySelectorAll('.tab-button').forEach((button) => {
        button.classList.toggle('active', button.dataset.tab === tabId);
      });
      document.querySelectorAll('.tab-panel').forEach((panel) => {
        panel.classList.toggle('active', panel.id === tabId);
      });
    }

    document.querySelectorAll('.tab-button').forEach((button) => {
      button.addEventListener('click', () => activateTab(button.dataset.tab));
    });

    const profileUI = {
      card: $('profileCard'),
      empty: $('profileCardEmpty'),
      avatar: $('profileAvatarPreview'),
      avatarLink: $('profileAvatarLink'),
      avatarPlaceholder: $('profileAvatarPlaceholder'),
      fields: {
        id: $('profileFieldId'),
        email: $('profileFieldEmail'),
        username: $('profileFieldUsername'),
        fullName: $('profileFieldFullName'),
        primaryRole: $('profileFieldPrimaryRole'),
        roles: $('profileFieldRoles'),
        profileCompleted: $('profileFieldCompleted'),
        createdAt: $('profileFieldCreatedAt'),
        updatedAt: $('profileFieldUpdatedAt'),
      },
    };

    const userListUI = {
      meta: $('userListMeta'),
      empty: $('userListEmpty'),
      list: $('userListItems'),
    };

    const managementUI = {
      authorToken: $('mgmtAuthorToken'),
      reviewerToken: $('mgmtReviewerToken'),
      createFields: $('mgmtCreateFields'),
    };

    function updateToken(newToken) {
      state.token = newToken || '';
      if (state.token) {
        localStorage.setItem('fitcity_token', state.token);
      } else {
        localStorage.removeItem('fitcity_token');
      }
      if ($('tokenDisplay')) {
        $('tokenDisplay').value = state.token;
      }
      if (managementUI.authorToken && !managementUI.authorToken.value.trim()) {
        managementUI.authorToken.value = state.token;
      }
    }

    updateToken(state.token);

    if (managementUI.authorToken) {
      if (!managementUI.authorToken.value.trim()) {
        managementUI.authorToken.value = state.token;
      }
    }

    if (managementUI.reviewerToken) {
      managementUI.reviewerToken.value = managementState.reviewerToken;
      managementUI.reviewerToken.addEventListener('input', (event) => {
        const value = event.target.value.trim();
        managementState.reviewerToken = value;
        if (value) {
          localStorage.setItem('fitcity_reviewer_token', value);
        } else {
          localStorage.removeItem('fitcity_reviewer_token');
        }
      });
    }

    if (managementUI.createFields && !managementUI.createFields.value.trim()) {
      managementUI.createFields.value = '{ "name": "Sample Destination", "city": "New York", "country": "USA", "category": "Nature", "description": "Iconic destination", "status": "draft" }';
    }

    function getAuthorToken() {
      const explicit = managementUI.authorToken ? managementUI.authorToken.value.trim() : '';
      return explicit || state.token;
    }

    function getReviewerToken() {
      const explicit = managementUI.reviewerToken ? managementUI.reviewerToken.value.trim() : '';
      return explicit || managementState.reviewerToken || '';
    }

    async function request(path, options = {}) {
      const { tokenOverride, ...rest } = options;
      const base = $('baseUrl').value.replace(/\/$/, '');
      const url = base + path;
      const headers = rest.headers ? { ...rest.headers } : {};
      const token = tokenOverride || state.token;
      if (token && !headers['Authorization']) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      const response = await fetch(url, { ...rest, headers });
      let bodyText;
      try {
        bodyText = await response.text();
      } catch (err) {
        bodyText = err.message;
      }
      let parsed;
      try {
        parsed = JSON.parse(bodyText);
      } catch {
        parsed = bodyText;
      }
      return { status: response.status, body: parsed };
    }

    function pretty(result) {
      return JSON.stringify(result, null, 2);
    }

    function formatDate(value) {
      if (!value) {
        return '—';
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return typeof value === 'string' ? value : '—';
      }
      return date.toLocaleString();
    }

    function getUserPayload(body) {
      if (!body || typeof body !== 'object') {
        return null;
      }
      const user = body.user;
      if (!user || typeof user !== 'object') {
        return null;
      }
      return user;
    }

    function renderProfile(user) {
      if (!profileUI.card || !profileUI.avatar) {
        return;
      }

      if (!user) {
        profileUI.card.classList.add('hidden');
        if (profileUI.empty) {
          profileUI.empty.classList.remove('hidden');
        }
        profileUI.avatar.src = PLACEHOLDER_IMAGE;
        profileUI.avatar.alt = 'Profile avatar placeholder';
        Object.values(profileUI.fields).forEach((el) => {
          if (el) {
            el.textContent = '—';
          }
        });
        if (profileUI.avatarLink) {
          profileUI.avatarLink.classList.add('hidden');
          profileUI.avatarLink.removeAttribute('href');
          profileUI.avatarLink.textContent = '';
        }
        if (profileUI.avatarPlaceholder) {
          profileUI.avatarPlaceholder.textContent = 'No avatar uploaded';
          profileUI.avatarPlaceholder.classList.remove('hidden');
        }
        return;
      }

      profileUI.card.classList.remove('hidden');
      if (profileUI.empty) {
        profileUI.empty.classList.add('hidden');
      }

      const setField = (key, value) => {
        const el = profileUI.fields[key];
        if (el) {
          el.textContent = value ?? '—';
        }
      };

      setField('id', user.id || '—');
      setField('email', user.email || '—');
      setField('username', user.username || '—');
      setField('fullName', user.full_name || '—');

      const roles = Array.isArray(user.roles) ? user.roles : [];
      if (roles.length > 0) {
        const primary = roles[0] || {};
        const primaryName = primary.role_name || primary.name || '';
        const primaryId = primary.id || '';
        const primaryLabel = [primaryName, primaryId ? `(${primaryId})` : ''].filter(Boolean).join(' ');
        setField('primaryRole', primaryLabel || '—');
        const formatted = roles.map((role) => {
          const name = role.role_name || role.name || '';
          const identifier = role.id ? `(${role.id})` : '';
          return [name, identifier].filter(Boolean).join(' ');
        });
        setField('roles', formatted.join(', '));
      } else {
        setField('primaryRole', '—');
        setField('roles', '—');
      }

      if (typeof user.profile_completed === 'boolean') {
        setField('profileCompleted', user.profile_completed ? 'Yes' : 'No');
      } else {
        setField('profileCompleted', '—');
      }

      setField('createdAt', formatDate(user.created_at));
      setField('updatedAt', formatDate(user.updated_at));

      const avatarUrl = user.user_image_url;
      if (avatarUrl) {
        profileUI.avatar.src = avatarUrl;
        profileUI.avatar.alt = 'Profile avatar';
        if (profileUI.avatarLink) {
          profileUI.avatarLink.textContent = avatarUrl;
          profileUI.avatarLink.href = avatarUrl;
          profileUI.avatarLink.classList.remove('hidden');
        }
        if (profileUI.avatarPlaceholder) {
          profileUI.avatarPlaceholder.classList.add('hidden');
        }
      } else {
        profileUI.avatar.src = PLACEHOLDER_IMAGE;
        profileUI.avatar.alt = 'Profile avatar placeholder';
        if (profileUI.avatarLink) {
          profileUI.avatarLink.classList.add('hidden');
          profileUI.avatarLink.removeAttribute('href');
          profileUI.avatarLink.textContent = '';
        }
        if (profileUI.avatarPlaceholder) {
          profileUI.avatarPlaceholder.textContent = 'No avatar uploaded';
          profileUI.avatarPlaceholder.classList.remove('hidden');
        }
      }
    }

    function renderUserList(result) {
      if (!userListUI.list) {
        return;
      }

      const resetList = () => {
        userListUI.list.classList.add('hidden');
        userListUI.list.innerHTML = '';
      };

      if (!result) {
        resetList();
        if (userListUI.meta) {
          userListUI.meta.textContent = '';
        }
        if (userListUI.empty) {
          userListUI.empty.textContent = 'No users loaded yet.';
          userListUI.empty.classList.remove('hidden');
        }
        return;
      }

      if (result.status <= 0 || result.status >= 400) {
        resetList();
        if (userListUI.meta) {
          const message = result && result.body && result.body.error ? `Error: ${result.body.error}` : '';
          userListUI.meta.textContent = message;
        }
        if (userListUI.empty) {
          userListUI.empty.textContent = 'Unable to load users.';
          userListUI.empty.classList.remove('hidden');
        }
        return;
      }

      const body = result.body || {};
      const meta = body.meta || {};
      const users = Array.isArray(body.users) ? body.users : [];

      if (userListUI.meta) {
        userListUI.meta.textContent = `count=${meta.count ?? '-'}, limit=${meta.limit ?? '-'}, offset=${meta.offset ?? '-'}`;
      }

      if (!users.length) {
        resetList();
        if (userListUI.empty) {
          userListUI.empty.textContent = 'Request successful, but no users returned.';
          userListUI.empty.classList.remove('hidden');
        }
        return;
      }

      userListUI.empty.classList.add('hidden');
      userListUI.list.classList.remove('hidden');
      userListUI.list.innerHTML = '';

      users.forEach((user) => {
        const li = document.createElement('li');
        const title = document.createElement('div');
        title.innerHTML = `<strong>${user.email || 'Unknown email'}</strong>`;
        li.appendChild(title);

        const metaLine = document.createElement('div');
        metaLine.className = 'user-meta';
        metaLine.textContent = `ID: ${user.id || '-'} • Username: ${user.username || '-'} • Roles: ${Array.isArray(user.roles) ? user.roles.map((role) => role.role_name || role.name || '').filter(Boolean).join(', ') : '-'}`;
        li.appendChild(metaLine);

        const dates = document.createElement('div');
        dates.className = 'user-meta';
        dates.textContent = `Created: ${formatDate(user.created_at)} • Updated: ${formatDate(user.updated_at)}`;
        li.appendChild(dates);

        userListUI.list.appendChild(li);
      });
    }

    function updateProfileFromResult(result) {
      if (!result) {
        return;
      }
      if (result.status === 401) {
        renderProfile(null);
        return;
      }
      if (result.status >= 400) {
        return;
      }
      const user = getUserPayload(result.body);
      if (user) {
        renderProfile(user);
      }
    }

    renderProfile(null);
    renderUserList(null);
    if (profileUI.avatar) {
      profileUI.avatar.addEventListener('error', () => {
        if (profileUI.avatar.src !== PLACEHOLDER_IMAGE) {
          profileUI.avatar.src = PLACEHOLDER_IMAGE;
        }
      });
    }

    async function loginWithGoogleToken(idToken) {
      const trimmed = idToken.trim();
      if (!trimmed) {
        if ($('googleResult')) {
          $('googleResult').textContent = pretty({ status: 0, body: 'Google ID token required' });
        }
        return null;
      }
      const result = await request('/api/v1/auth/google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token: trimmed }),
      });
      if ($('googleResult')) {
        $('googleResult').textContent = pretty(result);
      }
      if (result.status < 400 && result.body.token) {
        updateToken(result.body.token);
      }
      updateProfileFromResult(result);
      return result;
    }

    function handleGoogleCredentialResponse(response) {
      const credential = (response && response.credential) || '';
      if (!credential) {
        if ($('googleResult')) {
          $('googleResult').textContent = pretty({ status: 0, body: 'Google credential missing from response' });
        }
        return;
      }
      if ($('googleIdToken')) {
        $('googleIdToken').value = credential;
      }
      if ($('googleResult')) {
        $('googleResult').textContent = pretty({ status: 0, body: 'Received Google credential, exchanging with API...' });
      }
      loginWithGoogleToken(credential);
    }

    function renderGoogleButton() {
      if (!window.google || !google.accounts || !google.accounts.id) {
        return false;
      }
      const clientId = $('googleClientId').value.trim();
      if (!clientId) {
        if ($('googleButtonContainer')) {
          $('googleButtonContainer').innerHTML = '<span class="muted">Add a Google client ID to enable the sign-in button.</span>';
        }
        googleState.lastClientId = null;
        return true;
      }
      if (googleState.lastClientId === clientId && $('googleButtonContainer').children.length) {
        return true;
      }
      $('googleButtonContainer').innerHTML = '';
      google.accounts.id.initialize({
        client_id: clientId,
        callback: handleGoogleCredentialResponse,
      });
      google.accounts.id.renderButton(
        $('googleButtonContainer'),
        { type: 'standard', theme: 'outline', size: 'large' },
      );
      googleState.lastClientId = clientId;
      return true;
    }

    function scheduleGoogleButtonRender() {
      if (renderGoogleButton()) {
        if (googleState.initTimer) {
          clearInterval(googleState.initTimer);
          googleState.initTimer = null;
        }
        return;
      }

      if (!googleState.initTimer) {
        googleState.initTimer = setInterval(() => {
          if (renderGoogleButton() && googleState.initTimer) {
            clearInterval(googleState.initTimer);
            googleState.initTimer = null;
          }
        }, 500);
      }
    }

    scheduleGoogleButtonRender();

    function attachClick(id, handler) {
      const el = $(id);
      if (el) {
        el.addEventListener('click', handler);
      }
    }

    attachClick('regSubmit', async () => {
      const payload = {
        email: $('regEmail').value,
        password: $('regPassword').value,
      };
      const result = await request('/api/v1/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if ($('regResult')) {
        $('regResult').textContent = pretty(result);
      }
      if (result.status < 400 && result.body.token) {
        updateToken(result.body.token);
      }
      updateProfileFromResult(result);
    });

    attachClick('loginSubmit', async () => {
      const payload = {
        email: $('loginEmail').value,
        password: $('loginPassword').value,
      };
      const result = await request('/api/v1/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if ($('loginResult')) {
        $('loginResult').textContent = pretty(result);
      }
      if (result.status < 400 && result.body.token) {
        updateToken(result.body.token);
      }
      updateProfileFromResult(result);
    });

    attachClick('googleSubmit', () => {
      loginWithGoogleToken($('googleIdToken').value);
    });

    attachClick('profileSubmit', async () => {
      const formData = new FormData();
      const fullName = $('profileName').value.trim();
      const username = $('profileUsername').value.trim();
      if (fullName) {
        formData.append('full_name', fullName);
      }
      if (username) {
        formData.append('username', username);
      }
      const file = $('profileAvatar').files[0];
      if (file) {
        formData.append('avatar', file, file.name);
      }
      const result = await request('/api/v1/auth/profile', {
        method: 'POST',
        body: formData,
      });
      if ($('profileResult')) {
        $('profileResult').textContent = pretty(result);
      }
      updateProfileFromResult(result);
    });

    attachClick('changePasswordSubmit', async () => {
      const payload = {
        current_password: $('changeCurrentPassword').value,
        new_password: $('changeNewPassword').value,
      };
      const result = await request('/api/v1/auth/password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if ($('changePasswordResult')) {
        $('changePasswordResult').textContent = pretty(result);
      }
    });

    attachClick('resetRequestSubmit', async () => {
      const payload = { email: $('resetEmailRequest').value };
      const result = await request('/api/v1/auth/password/reset-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if ($('resetRequestResult')) {
        $('resetRequestResult').textContent = pretty(result);
      }
    });

    attachClick('resetConfirmSubmit', async () => {
      const payload = {
        email: $('resetEmailConfirm').value,
        otp: $('resetOTP').value,
        new_password: $('resetNewPassword').value,
      };
      const result = await request('/api/v1/auth/password/reset-confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if ($('resetConfirmResult')) {
        $('resetConfirmResult').textContent = pretty(result);
      }
    });

    attachClick('userListSubmit', async () => {
      const limit = Math.max(parseInt($('userListLimit').value, 10) || 0, 1);
      const offset = Math.max(parseInt($('userListOffset').value, 10) || 0, 0);
      const params = new URLSearchParams();
      params.set('limit', String(limit));
      params.set('offset', String(offset));
      const result = await request(`/api/v1/auth/users?${params.toString()}`);
      if ($('userListResult')) {
        $('userListResult').textContent = pretty(result);
      }
      renderUserList(result);
    });

    attachClick('meSubmit', async () => {
      const result = await request('/api/v1/auth/me');
      if ($('meResult')) {
        $('meResult').textContent = pretty(result);
      }
      updateProfileFromResult(result);
    });

    attachClick('logoutSubmit', async () => {
      const result = await request('/api/v1/auth/logout', { method: 'POST' });
      if ($('logoutResult')) {
        $('logoutResult').textContent = pretty(result);
      }
      if (result.status === 200) {
        updateToken('');
        renderProfile(null);
      }
    });

    function parseJsonFields(text, resultId) {
      try {
        return JSON.parse(text);
      } catch (err) {
        if ($(resultId)) {
          $(resultId).textContent = pretty({ status: 0, body: `Invalid JSON: ${err.message}` });
        }
        return null;
      }
    }

    attachClick('mgmtCreateSubmit', async () => {
      const action = $('mgmtCreateAction').value;
      const destinationId = $('mgmtCreateDestinationId').value.trim();
      const fieldsText = $('mgmtCreateFields').value || '{}';
      const fields = parseJsonFields(fieldsText, 'mgmtCreateResult');
      if (!fields) {
        return;
      }
      const payload = { action, fields };
      if (destinationId) {
        payload.destination_id = destinationId;
      }
      const result = await request('/api/v1/admin/destination-changes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        tokenOverride: getAuthorToken(),
      });
      if ($('mgmtCreateResult')) {
        $('mgmtCreateResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtSubmitChange', async () => {
      const changeId = $('mgmtSubmitChangeId').value.trim();
      if (!changeId) {
        if ($('mgmtSubmitResult')) {
          $('mgmtSubmitResult').textContent = pretty({ status: 0, body: 'Change request ID required' });
        }
        return;
      }
      const result = await request(`/api/v1/admin/destination-changes/${changeId}/submit`, {
        method: 'POST',
        tokenOverride: getAuthorToken(),
      });
      if ($('mgmtSubmitResult')) {
        $('mgmtSubmitResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtApproveChange', async () => {
      const changeId = $('mgmtApproveChangeId').value.trim();
      const token = getReviewerToken();
      if (!token) {
        if ($('mgmtApproveResult')) {
          $('mgmtApproveResult').textContent = pretty({ status: 0, body: 'Reviewer token required' });
        }
        return;
      }
      if (!changeId) {
        if ($('mgmtApproveResult')) {
          $('mgmtApproveResult').textContent = pretty({ status: 0, body: 'Change request ID required' });
        }
        return;
      }
      const result = await request(`/api/v1/admin/destination-changes/${changeId}/approve`, {
        method: 'POST',
        tokenOverride: token,
      });
      if ($('mgmtApproveResult')) {
        $('mgmtApproveResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtRejectChange', async () => {
      const changeId = $('mgmtRejectChangeId').value.trim();
      const message = $('mgmtRejectMessage').value;
      const token = getReviewerToken();
      if (!token) {
        if ($('mgmtRejectResult')) {
          $('mgmtRejectResult').textContent = pretty({ status: 0, body: 'Reviewer token required' });
        }
        return;
      }
      if (!changeId) {
        if ($('mgmtRejectResult')) {
          $('mgmtRejectResult').textContent = pretty({ status: 0, body: 'Change request ID required' });
        }
        return;
      }
      const result = await request(`/api/v1/admin/destination-changes/${changeId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
        tokenOverride: token,
      });
      if ($('mgmtRejectResult')) {
        $('mgmtRejectResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtHeroUpload', async () => {
      const changeId = $('mgmtHeroChangeId').value.trim();
      const fileInput = $('mgmtHeroFile');
      if (!changeId) {
        if ($('mgmtHeroResult')) {
          $('mgmtHeroResult').textContent = pretty({ status: 0, body: 'Change request ID required' });
        }
        return;
      }
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        if ($('mgmtHeroResult')) {
          $('mgmtHeroResult').textContent = pretty({ status: 0, body: 'Select an image file to upload' });
        }
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      const result = await request(`/api/v1/admin/destination-changes/${changeId}/hero-image`, {
        method: 'POST',
        body: formData,
        tokenOverride: getAuthorToken(),
      });
      if ($('mgmtHeroResult')) {
        $('mgmtHeroResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtListChanges', async () => {
      const params = new URLSearchParams();
      const status = $('mgmtListStatus').value.trim();
      const destination = $('mgmtListDestinationId').value.trim();
      const limit = Math.max(parseInt($('mgmtListLimit').value, 10) || 0, 1);
      const offset = Math.max(parseInt($('mgmtListOffset').value, 10) || 0, 0);
      if (status) {
        params.set('status', status);
      }
      if (destination) {
        params.set('destination_id', destination);
      }
      if (limit) {
        params.set('limit', String(limit));
      }
      params.set('offset', String(offset));
      const query = params.toString();
      const result = await request(`/api/v1/admin/destination-changes${query ? `?${query}` : ''}`, {
        tokenOverride: getAuthorToken(),
      });
      if ($('mgmtListResult')) {
        $('mgmtListResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtGetChange', async () => {
      const changeId = $('mgmtGetChangeId').value.trim();
      if (!changeId) {
        if ($('mgmtGetResult')) {
          $('mgmtGetResult').textContent = pretty({ status: 0, body: 'Change request ID required' });
        }
        return;
      }
      const result = await request(`/api/v1/admin/destination-changes/${changeId}`, {
        tokenOverride: getAuthorToken(),
      });
      if ($('mgmtGetResult')) {
        $('mgmtGetResult').textContent = pretty(result);
      }
    });

    attachClick('mgmtListPublished', async () => {
      const result = await request('/api/v1/destinations');
      if ($('mgmtListPublishedResult')) {
        $('mgmtListPublishedResult').textContent = pretty(result);
      }
    });

    activateTab('authTab');
  </script>
</body>
</html>
